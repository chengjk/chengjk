---
title: SSH学习笔记
date: 2018-04-27 17:34:06
tags: [study]
---

## 什么是SSH
SSH的英文全称是Secure Shell。使用SSH，你可以把所传输的数据加密压缩。
加密方式依赖于安全认证方式，秘钥的安全认证方式可以杜绝“中间人”的攻击方式，而且也能够防止DNS和IP欺骗；压缩的好处就是减少传输的数据亮，加快传输速度。

最初的SSH是由芬兰一家公司开发，版权的原因现在很多人都转而使用OpenSSH。OpenSSH是SSH的替代软件，而且开源。可预计将来会有更多的人加入OpenSSH阵营。

SSH 由客户端软件和服务端软件组成，一般安装SSH时会把客户端和服务端一并装上，建立安全连接时由客户端程序发起。

## SSH的安全验证如何工作
从客户端来看，SSH提供两种级别的验证方式。

第一种，基于口令的安全验证。口令需要在网络中传输。只要知道账号和口令，就可以登录远程主机。所传输的数据都会被加密压缩，但是不能保证你正在链接的就是你想连接的主机，也就是受到“中间人”这种方式攻击。
认证流程
1. 客户端发起连接请求
2. 服务端收到请求后把自己的公钥发给客户端
3. 客户端用接收到的公钥加密自己的口令再发给服务端
4. 服务端接收到口令密文，用自己的私钥解密获得口令明文。
5. 对比解密的口令和实际口令
6. 返回认证结果

上述流程中，如果第1步的连接请求被劫持，假服务端用自己的公钥去认证，就能获取客户端口令的明文。假服务的就可以用口令去攻击真服务端。这就是“中间人”的攻击方式。

第二种，给予秘钥的安全认证。需要有秘钥，也就是说必须创建一对秘钥，私钥自己保留（id_rsa），公钥(id_rsa.pub)分发到所有目标远端主机上，连接时使用这一对秘钥去认证。

认证流程
1. 客户端向服务端发起连接请求，携带自己的公钥
2. 服务端检查本地authorized_keys文件，检查接收到的公钥能否匹配
3. 匹配后，服务端发送质问信息（一段随机明文）给客户端。
4. 客户端接收质问信息并用自己的私钥加密，将质问密文发送给服务端
5. 服务端收到质问密文，再用authorized_keys文件中对应公钥去解密。
6. 服务器将获得的明文和自己第3步发送的明文进行对比
7. 返回认证结果

该流程中只有真服务器才有客户端的公钥，没有公钥就不能认证。所以杜绝了中间人的攻击方式。
完成上述流程后链接建立。
与第一种方式相比，基于秘钥的安全认证不需要在网络上传输口令。

### 生成SSH 秘钥

>ssh-keygen -t rsa -C "yourname@mail.com" 

其中 -t 指定加密算法，一般是 rsa。-C是注释，方便人工识别。
一路回车，最终会在~/.ssh 目录下生成两个文件：

> id_rsa   私钥
 id_rsa.pub 公钥

### 公钥分发

公钥分发是将本机公钥拷贝到远端主机authorized_keys文件。为建立本机到远端主机的安全连接做准备。

1. 远端自有机器。直接拷贝追加到目标文件。
2. github之类公共服务。这里服务会提供入口，把公钥文本粘贴过去即可。

上述流程中公钥传输都只传输公钥的签名。

## 相关文件以及用途

### id_rsa
私钥，用于基于秘钥的安全认证。自己保留不能丢失泄露，如果泄露就是把所有远端主机的权限交出去了。

### id_rsa.pub 
公钥，公开的不存在泄密问题，一般会分发到远端主机，用于建立安全连接。

### known_hosts 
已经连接过的地址，无论是基于口令还是基于秘钥，安全连接建立后都会在此加一条记录。
与所有远端主机首次建立安全连接时就会把主机地址写入known_hosts。也就是说knwon_hosts 中记录的地址都被认为是可信任的，一般用作初步的安全认证。


### authorized_keys 
认证信息。存储的戳客户端的公钥，在这里记录过的客户端都可以免密码登录。注意这里只是从客户端到本机，如果要实现双向的免密码登录，需要在每台主机追加对方的公钥。

---
什么是公钥和私钥。参考 [数字签名是什么][1]。


  [1]: http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html